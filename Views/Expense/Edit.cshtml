@model RouteDetail

<script>
    $(document).ready(function () {
        $('input[type="number"]').on('keyup', function () {
            if ($(this).val() < 0) {
                $(this).val(0);
            }
        });
        hideExistedExpenseOnRoutesData();
        UpdateIdValuesDynamically();
        //Hide the existed Expense on Routes
        function hideExistedExpenseOnRoutesData() {
            
            $(".DeleteExpenseOnRouteTypes").hide();
            $(".Amount").prop('disabled', true);
            $(".ExpenseTypeId").prop('disabled', true);
        }

        function UpdateIdValuesDynamically() {
            var count = 1;
            $('.Amount').each(function () {
                if (this.id) {
                    this.id = this.id.split('-')[0] + "-" + count;
                    count++;
                }
            });
            count = 1;
            $('.ExpenseTypeId').each(function () {
                if (this.id) {
                    this.id = this.id.split('-')[0] + "-" + count;
                    count++;
                }
            });
            count = 1;
            $('.ErrAmount').each(function () {
                if (this.id) {
                    this.id = this.id.split('-')[0] + "-" + count;
                    count++;
                }
            });
            count = 1;
            $('.ExpenseOnRouteID').each(function () {
                if (this.id) {
                    this.id = this.id.split('-')[0] + "-" + count;
                    count++;
                }
            });
        }

        $("#AddExpenseTypes").click(function () {
            //$("#ExpenseOnRouteTypes").clone().appendTo($("#ExpenseTypes"));
            $.ajax({
                url: '/Expense/ExpenseOnRoute',
                success: function (partialView) {
                    $('#ExpenseTypes').append(partialView);
                    UpdateIdValuesDynamically();
                }
            });

        });

        function PreSave() {
            var validform = true;
            if ($("#BuiltyNo").val() == '') {
                $("#ErrBuiltyNo").html("Required *");
                validform = false;
            }
            if ($("#DriveName").val() == '') {
                $("#ErrDriveName").html("Required *");
                validform = false;
            }
            if ($("#TruckNo").val() == '') {
                $("#ErrTruckNo").html("Required *");
                validform = false;
            }
            if ($("#Date").val() == '') {
                $("#ErrDate").html("Required *");
                validform = false;
            }
            if (isNaN($("#Weight").val()) || $("#Weight").val() == '') {
                $("#ErrWeight").html("Required *");
                validform = false;
            }
            if (isNaN($("#FromFare").val()) || $("#FromFare").val() == '') {
                $("#ErrFromFare").html("Required *");
                validform = false;
            }
            if (isNaN($("#ToFare").val()) || $("#ToFare").val() == '') {
                $("#ErrToFare").html("Required *");
                validform = false;
            }
            var count = 1;
            $('.Amount').each(function () {
                var val = parseFloat($(this).val());
                if (isNaN(val) || val < 0) {
                    $("#ErrAmount-" + count).html("Required *");
                    validform = false;
                }
                count++;
            });
            return validform;
        }

        $("#SaveBuilty").click(function () {
            debugger;
            if (PreSave()) {
                var Model = {};
                Model.RouteID = $("#RouteID").val();
                Model.BuiltyNo = $("#BuiltyNo").val();
                Model.DriveName = $("#DriveName").val();
                Model.TruckNo = $("#TruckNo").val();
                Model.Date = $("#Date").val();
                Model.Weight = parseInt($("#Weight").val());
                Model.FromStation = $("#FromStation").val();
                Model.ToStation = $("#ToStation").val();
                Model.FromFare = parseFloat($("#FromFare").val());
                Model.ToFare = parseFloat($("#ToFare").val());
                Model.TotalFare = parseFloat($("#TotalFare").val());
                Model.TotalExpense = parseFloat($("#TotalExpense").val());
                Model.TotalIncome = parseFloat($("#TotalIncome").val());
                Model.Expenses = [];
                var count = 1;
                $('.Amount').each(function () {
                    var ExpenseType = {};
                    ExpenseType.ExpenseOnRouteID = parseInt($("#ExpenseOnRouteID-"+count).val());
                    ExpenseType.ExpenseTypeId = parseInt($("#ExpenseTypeId-" + count).val());
                    ExpenseType.Amount = parseFloat($("#Amount-" + count).val());
                    Model.Expenses.push(ExpenseType);
                    count++;
                });
                //Model = JSON.stringify({ 'Model': Model });
                $.ajax({
                    url: "/Expense/UpdateBuilty",
                    type: "Post",
                    data: Model,
                    success: function (response) {
                        debugger;
                        if (response.isSaved) {
                            Swal.fire({
                                title: "Success!",
                                text: "Builty Saved Successfully!",
                                icon: "success"
                            });
                        }
                        else
                        {
                            Swal.fire({
                                icon: "error",
                                title: "Oops...",
                                text: "Something went wrong!"
                            });
                        }
                    },
                    failure: function (response) {
                        Swal.fire({
                            icon: "error",
                            title: "Oops...",
                            text: "Something went wrong!"
                        });
                    }
                });
            }
        });

        function CalculateTotalIncome() {
            var result = 0;
            var TotalFare = parseFloat($("#TotalFare").val());
            if (isNaN(TotalFare)) {
                TotalFare = 0;
            }
            var TotalExpense = parseFloat($("#TotalExpense").val());
            if (isNaN(TotalExpense)) {
                TotalExpense = 0;
            }
            result = TotalFare - TotalExpense;
            $('#TotalIncome').val(result.toFixed(2));
        }

        function CalculateTotalExpenseTypeAmount() {
            var sum = 0;
            $('.Amount').each(function () {
                var val = parseFloat($(this).val());
                if (!isNaN(val) && val >= 0) {
                    sum += val;
                }
                else {
                    $(this).val(0)
                }
            });
            $('#TotalExpense').val(sum.toFixed(2));
            CalculateTotalIncome();
        }

        $(document).on('input', '.Amount', function () {
            CalculateTotalExpenseTypeAmount();
        });

        $("#FromFare, #ToFare").on('change', function () {
            debugger;
            var sum = 0;
            var FromFare = parseFloat($("#FromFare").val());
            if (isNaN(FromFare) || FromFare <= 0) {
                FromFare = 0;
            }
            sum += FromFare;
            var ToFare = parseFloat($("#ToFare").val());
            if (isNaN(ToFare) || ToFare <= 0) {
                ToFare = 0;
            }
            sum += ToFare;
            debugger;
            $('#TotalFare').val(sum.toFixed(2));
            CalculateTotalIncome();
        });

        $('#ExpenseTypes').on('click', '.DeleteExpenseOnRouteTypes', function () {
            $(this).closest('#ExpenseOnRouteTypes').remove();
            CalculateTotalExpenseTypeAmount();
            UpdateIdValuesDynamically();
        });

        $("#Back").click(function () {
            window.location.href = '/Expense/Index';
        });
    });
</script>


<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-12">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="#">Route Detail</a></li>
                    <li class="breadcrumb-item active">Create</li>
                </ol>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title">Edit Builty</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="BuiltyNo">Builty No:</label>
                            <input type="hidden" class="form-control" id="RouteID" value="@Model.RouteID">
                            <input type="text" class="form-control" id="BuiltyNo" value="@Model.BuiltyNo" placeholder="Builty Number" disabled="disabled">
                            <label id="ErrBuiltyNo" style="color:red;"></label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="DriveName">Driver Name:</label>
                            <input type="text" class="form-control" id="DriveName" value="@Model.DriveName" placeholder="Drive Name">
                            <label id="ErrDriveName" style="color:red;"></label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="TruckNo">Truck No:</label>
                            <input type="text" class="form-control" id="TruckNo" value="@Model.TruckNo" placeholder="Truck Number">
                            <label id="ErrTruckNo" style="color:red;"></label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="Date">Date:</label>
                            @{
                                string Month = Model.Date.Month < 10 ? "0" + Model.Date.Month : Model.Date.Month.ToString();
                                string day = Model.Date.Day < 10 ? "0" + Model.Date.Day : Model.Date.Day.ToString();
                                string date = Model.Date.Year + "-" + Month + "-" + day;
                            }
                            <input type="date" class="form-control" value="@date" id="Date">
                            <label id="ErrDate" style="color:red;"></label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="Weight">Weight:</label>
                            <input type="number" class="form-control" id="Weight" value="@Model.Weight" placeholder="Weight">
                            <label id="ErrWeight" style="color:red;"></label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="FromStation">From Station:</label>
                            @Html.DropDownListFor(model => model.FromStation, (SelectList)ViewData["StationDDL"], new { @class = "form-control", style = "width: 100%;", id = "FromStation" })
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="ToStation">To Station:</label>
                            @Html.DropDownListFor(model => model.ToStation, (SelectList)ViewData["StationDDL"], new { @class = "form-control", style = "width: 100%;", id = "ToStation" })
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="FromFare">From-Fare:</label>
                            <input type="number" class="form-control" id="FromFare" value="@Model.FromFare">
                            <label id="ErrFromFare" style="color:red;"></label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="ToFare">To-Fare:</label>
                            <input type="number" class="form-control" id="ToFare" value="@Model.ToFare">
                            <label id="ErrToFare" style="color:red;"></label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="TotalFare">Total Fare:</label>
                            <input type="number" class="form-control" id="TotalFare" disabled="disabled" value="@Model.TotalFare">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="TotalExpense">Total Expense:</label>
                            <input type="email" class="form-control" id="TotalExpense" disabled="disabled" value="@Model.TotalExpense">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="TotalIncome">Total Income:</label>
                            <input type="email" class="form-control" id="TotalIncome" disabled="disabled" value="@Model.TotalIncome">
                        </div>
                    </div>
                </div>
                <hr />
                <span class="input-group-append">
                    <button type="button" class="btn btn-success btn-flat" id="AddExpenseTypes">Add</button>
                </span>
                <div id="ExpenseTypes">
                    @if (Model.Expenses != null && Model.Expenses.Count() > 0)
                    {
                        @foreach (var ExpenseOnRoute in Model.Expenses)
                        {
                            @Html.Partial("ExpenseOnRoute", ExpenseOnRoute)
                        }
                    }
                </div>
                <span class="input-group-append">
                    <button type="button" class="btn btn-primary btn-flat" id="SaveBuilty">Save Builty</button>
                    <button type="button" class="btn btn-danger btn-flat" style="margin-left: 10px;" id="Back">Back</button>
                </span>
            </div>
        </div>
    </div>
</div>